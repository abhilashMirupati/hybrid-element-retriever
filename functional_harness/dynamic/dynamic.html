<!DOCTYPE html>
<html>
<head>
    <title>Dynamic DOM Churn Test</title>
    <style>
        .container { padding: 20px; }
        .item { 
            padding: 10px; 
            margin: 5px; 
            border: 1px solid #ddd;
            transition: all 0.3s;
        }
        .new-item { background: #e8f5e9; }
        .updating { background: #fff3e0; }
        .removing { background: #ffebee; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dynamic Content Updates</h1>
        
        <div id="controls">
            <button id="start-churn">Start DOM Churn</button>
            <button id="stop-churn">Stop Churn</button>
            <button id="add-item">Add Item</button>
            <button id="remove-item">Remove Item</button>
            <button id="shuffle">Shuffle Items</button>
        </div>
        
        <div id="dynamic-list">
            <div class="item" data-id="1">
                <span>Item 1</span>
                <button class="action-btn">Action 1</button>
            </div>
            <div class="item" data-id="2">
                <span>Item 2</span>
                <button class="action-btn">Action 2</button>
            </div>
            <div class="item" data-id="3">
                <span>Item 3</span>
                <button class="action-btn">Action 3</button>
            </div>
        </div>
        
        <div id="stats">
            <p>Updates: <span id="update-count">0</span></p>
            <p>Current Items: <span id="item-count">3</span></p>
        </div>
    </div>
    
    <script>
        let churnInterval = null;
        let updateCount = 0;
        let itemCounter = 3;
        
        function updateStats() {
            document.getElementById('update-count').textContent = ++updateCount;
            document.getElementById('item-count').textContent = 
                document.querySelectorAll('#dynamic-list .item').length;
        }
        
        function addRandomItem() {
            const list = document.getElementById('dynamic-list');
            const newItem = document.createElement('div');
            newItem.className = 'item new-item';
            newItem.dataset.id = ++itemCounter;
            newItem.innerHTML = `
                <span>Item ${itemCounter}</span>
                <button class="action-btn">Action ${itemCounter}</button>
            `;
            
            // Insert at random position
            const items = list.children;
            const randomIndex = Math.floor(Math.random() * items.length);
            if (randomIndex < items.length) {
                list.insertBefore(newItem, items[randomIndex]);
            } else {
                list.appendChild(newItem);
            }
            
            // Remove highlight after animation
            setTimeout(() => {
                newItem.classList.remove('new-item');
            }, 1000);
            
            updateStats();
        }
        
        function removeRandomItem() {
            const items = document.querySelectorAll('#dynamic-list .item');
            if (items.length > 1) {
                const randomItem = items[Math.floor(Math.random() * items.length)];
                randomItem.classList.add('removing');
                setTimeout(() => {
                    randomItem.remove();
                    updateStats();
                }, 300);
            }
        }
        
        function updateRandomItem() {
            const items = document.querySelectorAll('#dynamic-list .item');
            if (items.length > 0) {
                const randomItem = items[Math.floor(Math.random() * items.length)];
                randomItem.classList.add('updating');
                
                // Change content
                const span = randomItem.querySelector('span');
                const button = randomItem.querySelector('button');
                const id = randomItem.dataset.id;
                
                span.textContent = `Updated Item ${id} (${Date.now()})`;
                button.textContent = `New Action ${id}`;
                
                setTimeout(() => {
                    randomItem.classList.remove('updating');
                }, 500);
                
                updateStats();
            }
        }
        
        function shuffleItems() {
            const list = document.getElementById('dynamic-list');
            const items = Array.from(list.children);
            
            // Fisher-Yates shuffle
            for (let i = items.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [items[i], items[j]] = [items[j], items[i]];
            }
            
            // Clear and re-append
            list.innerHTML = '';
            items.forEach(item => list.appendChild(item));
            
            updateStats();
        }
        
        function startChurn() {
            if (churnInterval) return;
            
            churnInterval = setInterval(() => {
                const action = Math.random();
                if (action < 0.3) {
                    addRandomItem();
                } else if (action < 0.5) {
                    removeRandomItem();
                } else if (action < 0.8) {
                    updateRandomItem();
                } else {
                    shuffleItems();
                }
            }, 1000);
        }
        
        function stopChurn() {
            if (churnInterval) {
                clearInterval(churnInterval);
                churnInterval = null;
            }
        }
        
        // Event listeners
        document.getElementById('start-churn').addEventListener('click', startChurn);
        document.getElementById('stop-churn').addEventListener('click', stopChurn);
        document.getElementById('add-item').addEventListener('click', addRandomItem);
        document.getElementById('remove-item').addEventListener('click', removeRandomItem);
        document.getElementById('shuffle').addEventListener('click', shuffleItems);
        
        // Simulate stale element references
        let cachedElements = document.querySelectorAll('.action-btn');
        
        // Try to use cached elements after DOM changes
        setTimeout(() => {
            console.log('Cached elements may be stale:', cachedElements);
            // Elements might be removed/replaced by this point
        }, 5000);
    </script>
</body>
</html>